<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiDB Items Manager</title>
</head>
<body>
    <div class="app">
        <div class="container">
            <header>
                <h1>TiDB Items Manager</h1>
                <p>A simple CRUD application with Node.js, HTML, and TiDB</p>
            </header>

            <div id="errorMessage" class="error-message"></div>

            <!-- Login Screen -->
            <div id="loginScreen">
                <div class="login-form">
                    <h2>Login</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="username">Username or Email *</label>
                            <input type="text" id="username" name="username" placeholder="Enter username or email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password *</label>
                            <input type="password" id="password" name="password" placeholder="Enter password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Login</button>
                            <button type="button" class="btn btn-link" onclick="showRegister()">Register</button>
                        </div>
                    </form>
                </div>

                <div id="registerForm" class="login-form hidden">
                    <h2>Register</h2>
                    <form id="registerFormElement">
                        <div class="form-group">
                            <label for="regUsername">Username *</label>
                            <input type="text" id="regUsername" name="regUsername" placeholder="Enter username" required>
                        </div>
                        <div class="form-group">
                            <label for="regEmail">Email *</label>
                            <input type="email" id="regEmail" name="regEmail" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label for="regPassword">Password *</label>
                            <input type="password" id="regPassword" name="regPassword" placeholder="Enter password (min 6 characters)" required minlength="6">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Register</button>
                            <button type="button" class="btn btn-link" onclick="showLogin()">Back to Login</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Main App Screen -->
            <div id="appScreen" class="hidden">
                <div class="user-info">
                    <span>Logged in</span>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>

                <div class="item-form">
                    <h2 id="formTitle">Add New Item</h2>
                    <form id="itemForm">
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" id="name" name="name" placeholder="Enter item name" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" placeholder="Enter item description" rows="3"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="submitBtn">Create</button>
                            <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div id="loading" class="loading">Loading items...</div>
                <div id="itemList" class="item-list" style="display: none;">
                    <h2 id="itemsCount">Items (0)</h2>
                    <div id="itemsGrid" class="items-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';
        let items = [];
        let editingItemId = null;
        let authToken = localStorage.getItem('authToken');

        // DOM elements
        const errorMessage = document.getElementById('errorMessage');
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const registerFormElement = document.getElementById('registerFormElement');
        const itemForm = document.getElementById('itemForm');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const loading = document.getElementById('loading');
        const itemList = document.getElementById('itemList');
        const itemsGrid = document.getElementById('itemsGrid');
        const itemsCount = document.getElementById('itemsCount');
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');

        // Check if user is logged in
        if (authToken) {
            showApp();
        } else {
            showLogin();
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = `Error: ${message}`;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        // Show login screen
        function showLogin() {
            loginScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
            registerForm.classList.add('hidden');
            document.getElementById('loginForm').parentElement.classList.remove('hidden');
        }

        // Show register screen
        function showRegister() {
            document.getElementById('loginForm').parentElement.classList.add('hidden');
            registerForm.classList.remove('hidden');
        }

        // Show app screen
        function showApp() {
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            fetchItems();
        }

        // Get auth headers
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        // Register
        registerFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            if (!username || !email || !password) {
                showError('All fields are required');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                showError('Registration successful! Please login.');
                setTimeout(() => {
                    showLogin();
                    registerFormElement.reset();
                }, 1500);
            } catch (err) {
                showError(err.message);
                console.error('Error registering:', err);
            }
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showError('Username and password are required');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                showApp();
                loginForm.reset();
            } catch (err) {
                showError(err.message);
                console.error('Error logging in:', err);
            }
        });

        // Logout
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            showLogin();
            items = [];
        }

        // Fetch all items
        async function fetchItems() {
            try {
                loading.style.display = 'block';
                itemList.style.display = 'none';
                
                const response = await fetch(`${API_URL}/items`, {
                    headers: getAuthHeaders(),
                });

                if (response.status === 401) {
                    logout();
                    showError('Session expired. Please login again.');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch items');
                }
                items = await response.json();
                renderItems();
            } catch (err) {
                showError(err.message);
                console.error('Error fetching items:', err);
            } finally {
                loading.style.display = 'none';
                itemList.style.display = 'block';
            }
        }

        // Render items
        function renderItems() {
            itemsCount.textContent = `Items (${items.length})`;
            
            if (items.length === 0) {
                itemsGrid.innerHTML = '<div class="empty-state">No items found. Create your first item above!</div>';
                return;
            }

            itemsGrid.innerHTML = items.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <h3>${escapeHtml(item.name)}</h3>
                        <div class="item-actions">
                            <button class="btn btn-edit" onclick="editItem(${item.id})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="deleteItem(${item.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    ${item.description ? `<p class="item-description">${escapeHtml(item.description)}</p>` : ''}
                    <div class="item-meta">
                        <small>Created: ${new Date(item.created_at).toLocaleString()}</small>
                        ${item.updated_at !== item.created_at ? `<small>Updated: ${new Date(item.updated_at).toLocaleString()}</small>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create item
        async function createItem(itemData) {
            try {
                const response = await fetch(`${API_URL}/items`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(itemData),
                });

                if (response.status === 401) {
                    logout();
                    showError('Session expired. Please login again.');
                    return;
                }

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to create item');
                }
                await fetchItems();
                resetForm();
            } catch (err) {
                showError(err.message);
                console.error('Error creating item:', err);
            }
        }

        // Update item
        async function updateItem(id, itemData) {
            try {
                const response = await fetch(`${API_URL}/items/${id}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(itemData),
                });

                if (response.status === 401) {
                    logout();
                    showError('Session expired. Please login again.');
                    return;
                }

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to update item');
                }
                await fetchItems();
                resetForm();
            } catch (err) {
                showError(err.message);
                console.error('Error updating item:', err);
            }
        }

        // Delete item
        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/items/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                });

                if (response.status === 401) {
                    logout();
                    showError('Session expired. Please login again.');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to delete item');
                }
                await fetchItems();
            } catch (err) {
                showError(err.message);
                console.error('Error deleting item:', err);
            }
        }

        // Edit item
        function editItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;

            editingItemId = id;
            nameInput.value = item.name;
            descriptionInput.value = item.description || '';
            formTitle.textContent = 'Edit Item';
            submitBtn.textContent = 'Update';
            cancelBtn.style.display = 'block';
            nameInput.focus();
        }

        // Reset form
        function resetForm() {
            editingItemId = null;
            itemForm.reset();
            formTitle.textContent = 'Add New Item';
            submitBtn.textContent = 'Create';
            cancelBtn.style.display = 'none';
        }

        // Form submit handler
        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim();

            if (!name) {
                showError('Name is required');
                return;
            }

            const itemData = { name, description };
            
            if (editingItemId) {
                await updateItem(editingItemId, itemData);
            } else {
                await createItem(itemData);
            }
        });

        // Cancel button handler
        cancelBtn.addEventListener('click', () => {
            resetForm();
        });
    </script>
</body>
</html>
